name: Build and Push Docker Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: shopedge-app
  IMAGE_NAME: shopedge-app/shopedge-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
        #service_account:
        # Remove token_format or hset it to 'id_token'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t $REGISTRY/$PROJECT_ID/$IMAGE_NAME:$GITHUB_SHA ./app

    - name: Push Docker image
      run: |
        docker push $REGISTRY/$PROJECT_ID/$IMAGE_NAME:$GITHUB_SHA
        docker tag $REGISTRY/$PROJECT_ID/$IMAGE_NAME:$GITHUB_SHA $REGISTRY/$PROJECT_ID/$IMAGE_NAME:latest
        docker push $REGISTRY/$PROJECT_ID/$IMAGE_NAME:latest
#deployment
    - name: Trigger Jenkins Deployment
      run: |
        curl -X POST ${{ secrets.JENKINS_URL }}/job/shopedge-deploy/build \
          --user ${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }} \
          --data-urlencode json='{"parameter": [{"name":"IMAGE_TAG", "value":"'"$GITHUB_SHA"'"}]}'

    - name: Update Kubernetes manifest
      run: |
        sed -i "s|IMAGE_PLACEHOLDER|$REGISTRY/$PROJECT_ID/$IMAGE_NAME:$GITHUB_SHA|g" k8s/app-deployment.yaml
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add k8s/app-deployment.yaml
        git commit -m "Update image tag to $GITHUB_SHA" || echo "No changes to commit"
        git push