pipeline {
    agent any
    
    environment {
        GCP_PROJECT = 'striking-water-472711-g2'
        GKE_CLUSTER = 'shopedgedge-cluster'
        GKE_ZONE = 'us-central1'
    }
    
    stages {
        stage('Debug Info') {
            steps {
                bat """
                    echo "GCP Project: %GCP_PROJECT%"
                    echo "GKE Cluster: %GKE_CLUSTER%"
                    echo "Current directory:"
                    cd
                    echo "Files in workspace:"
                    dir
                """
            }
        }
        
        stage('Test Credentials') {
            steps {
                script {
                    try {
                        withCredentials([file(credentialsId: 'gcp-service-account', variable: 'GC_KEY')]) {
                            bat """
                                echo "Credential file path: %GC_KEY%"
                                echo "File exists:"
                                if exist "%GC_KEY%" (echo YES) else (echo NO)
                                echo "File size:"
                                for /f %%%%i in ('%GC_KEY%') do echo %%~zi
                            """
                        }
                    } catch (Exception e) {
                        echo "Credential error: ${e.getMessage()}"
                    }
                }
            }
        }
        
        stage('Test GCloud Auth') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'gcp-service-account', variable: 'GC_KEY')]) {
                        bat """
                            echo "Testing GCloud authentication..."
                            gcloud auth activate-service-account --key-file="%GC_KEY%" --verbosity=debug
                            gcloud config set project %GCP_PROJECT%
                            gcloud projects describe %GCP_PROJECT%
                        """
                    }
                }
            }
        }
    }
}